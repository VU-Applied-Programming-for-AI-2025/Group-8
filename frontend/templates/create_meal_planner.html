<!-- <form method="POST" action="/recommendations/mealplanner/create">
    <label>Number of days:</label>
    <input type="number" name="days" min="1" max="31" value="7" required><br>
    <label>Meals to plan:</label>
    <input type="checkbox" name="meals" value="breakfast" checked> Breakfast
    <input type="checkbox" name="meals" value="lunch" checked> Lunch
    <input type="checkbox" name="meals" value="dinner" checked> Dinner
    <br>
    <button type="submit">Create Meal Planner</button>
</form> -->

{% extends "base.html" %}

{% block title %}Create Custom Meal Plan - NutriSpoon{% endblock %}

{% block content %}
<div class="card">
    <h1 class="card-title">Create Your Custom Meal Plan</h1>
    <p>Select recipes to include in your personalized meal plan.</p>
</div>

<form method="POST" action="{{ url_for('meal_planner') }}">
    <div class="card">
        <h2 class="card-title">Plan Configuration</h2>
        
        <div class="form-row" style="display: flex; gap: 1rem; margin-bottom: 1.5rem;">
            <div class="form-group" style="flex: 1;">
                <label for="timeFrame" class="form-label">Duration:</label>
                <select id="timeFrame" name="timeFrame" class="form-control" required>
                    <option value="day">1 Day</option>
                    <option value="week" selected>1 Week</option>
                </select>
            </div>
            
            <div class="form-group" style="flex: 1;">
                <label for="calories" class="form-label">Target Calories (optional):</label>
                <input type="number" id="calories" name="calories" class="form-control" placeholder="e.g. 2000">
            </div>
        </div>
        
        <div class="form-group">
            <label class="form-label">Include Meals For:</label>
            <div class="meal-type-options" style="display: flex; flex-wrap: wrap; gap: 1rem;">
                {% for meal_type in ['breakfast', 'lunch', 'dinner', 'snacks'] %}
                <label class="meal-type-option">
                    <input type="checkbox" name="mealTypes" value="{{ meal_type }}" checked>
                    <span>{{ meal_type|capitalize }}</span>
                </label>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="card">
        <h2 class="card-title">Select Recipes</h2>
        
        <div id="selected-count" style="margin-bottom: 1rem; font-weight: 600; color: var(--primary);">
            0 recipes selected
        </div>
        
        <div class="recipe-selection">
            {% if user.saved_recipes or recipes_by_meal %}
                <div class="recipe-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem;">
                    <!-- Recommended Recipes -->
                    {% for category, recipes in recipes_by_meal.items() %}
                        {% for recipe in recipes %}
                        <div class="recipe-card">
                            <img src="{{ recipe.image }}" alt="{{ recipe.title }}" class="recipe-img">
                            <div class="recipe-body">
                                <h4>{{ recipe.title }}</h4>
                                <p class="meal-type">{{ category|capitalize }}</p>
                                <label class="recipe-select">
                                    <input type="checkbox" name="meals" value="{{ recipe.id }}" class="recipe-checkbox">
                                    Select
                                </label>
                            </div>
                        </div>
                        {% endfor %}
                    {% endfor %}
                    
                    <!-- Saved Recipes -->
                    {% if user.saved_recipes %}
                        <div style="grid-column: 1 / -1; margin-top: 1rem;">
                            <h3>Your Saved Recipes</h3>
                        </div>
                        {% for recipe_id in user.saved_recipes %}
                        <div class="recipe-card saved-recipe" data-recipe-id="{{ recipe_id }}">
                            <div class="recipe-img-placeholder"></div>
                            <div class="recipe-body">
                                <h4>Loading recipe...</h4>
                                <label class="recipe-select">
                                    <input type="checkbox" name="meals" value="{{ recipe_id }}" class="recipe-checkbox">
                                    Select
                                </label>
                            </div>
                        </div>
                        {% endfor %}
                    {% endif %}
                </div>
            {% else %}
                <p class="text-muted">No recipes available to select. <a href="/recommendations">Browse recipes</a> first.</p>
            {% endif %}
        </div>
    </div>

    <div class="card" style="text-align: center;">
        <button type="submit" class="btn btn-accent" style="width: 100%;" disabled id="submit-btn">
            Create Meal Plan
        </button>
    </div>
</form>

<style>
    .recipe-card {
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .recipe-img {
        width: 100%;
        height: 150px;
        object-fit: cover;
    }
    
    .recipe-img-placeholder {
        width: 100%;
        height: 150px;
        background: #f8f9fa;
    }
    
    .recipe-body {
        padding: 1rem;
    }
    
    .recipe-body h4 {
        margin: 0 0 0.5rem 0;
        font-size: 1rem;
    }
    
    .meal-type {
        color: #6c757d;
        font-size: 0.85rem;
        margin-bottom: 0.5rem;
    }
    
    .recipe-select {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .meal-type-option {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: #f8f9fa;
        border-radius: 8px;
        cursor: pointer;
    }
    
    .text-muted {
        color: #6c757d;
        text-align: center;
        padding: 2rem;
    }
</style>

<script>
document.addEventListener("DOMContentLoaded", function() {
    // Update selection count
    function updateSelectionCount() {
        const selected = document.querySelectorAll('.recipe-checkbox:checked').length;
        document.getElementById('selected-count').textContent = 
            `${selected} recipe${selected !== 1 ? 's' : ''} selected`;
        document.getElementById('submit-btn').disabled = selected === 0;
    }
    
    // Add event listeners to checkboxes
    document.querySelectorAll('.recipe-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectionCount);
    });
    
    // Load saved recipe details
    document.querySelectorAll('.saved-recipe').forEach(card => {
        const recipeId = card.dataset.recipeId;
        fetch(`/recipe/${recipeId}`)
            .then(response => response.json())
            .then(recipe => {
                if (recipe) {
                    card.innerHTML = `
                        <img src="${recipe.image}" alt="${recipe.title}" class="recipe-img">
                        <div class="recipe-body">
                            <h4>${recipe.title}</h4>
                            <p class="meal-type">Saved Recipe</p>
                            <label class="recipe-select">
                                <input type="checkbox" name="meals" value="${recipeId}" class="recipe-checkbox">
                                Select
                            </label>
                        </div>
                    `;
                    // Reattach event listener
                    card.querySelector('.recipe-checkbox').addEventListener('change', updateSelectionCount);
                }
            })
            .catch(error => {
                console.error('Error loading recipe:', error);
                card.querySelector('h4').textContent = 'Failed to load recipe';
            });
    });
});
</script>
{% endblock %}