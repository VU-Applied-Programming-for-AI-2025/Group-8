{% extends "base.html" %}

{% block title %}Personalized Meal Recommendations{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='styles/meals.css') }}">
{% endblock %}

{% block content %}
<h1 class="recipe-main-title">Your Personalized Recipe Selection</h1>
<p class="recipe-subtitle">
  Choose your favorite recipes below to build a custom meal plan tailored to your preferences.<br>
  Select recipes to add them to your plan, or click the heart to save favorites for later.
</p>

<form action="/recommendations/mealplanner/create" method="POST">
  {% if recipes_by_meal %}
    {% for category, recipes in recipes_by_meal.items() %}
      <div class="recipe-carousel-section">
        <h2 class="recipe-carousel-title">{{ category.capitalize() }}</h2>
        <div class="recipe-carousel-wrapper">
          <button type="button" class="recipe-carousel-nav recipe-carousel-nav-left" onclick="scrollCarousel(this, -1)">‹</button>
          <div class="recipe-carousel" id="carousel-{{ loop.index }}">
            {% for entry in recipes %}
              <div class="recipe-card-wrapper">
                <label class="recipe-card">
                  <input type="checkbox" class="recipe-meal-checkbox" name="meals" value="{{ entry['id'] }}" onchange="toggleOverlay(this)">
                  <button type="button" class="recipe-save-button" data-id="{{ entry['id'] }}" data-saved="false" onclick="toggleFavorite(event, this)">♥</button>
                  <a href="{{ url_for('recipe_details', recipe_id = entry['id']) }}">
                    <img src="{{ entry['image'] }}" alt="{{ entry['title'] }}">
                    <div class="recipe-info-banner">
                      <div class="recipe-title">{{ entry['title'] }}</div>
                    </div>
                  </a>
                  <div class="recipe-white-overlay"></div>
                </label>
              </div>
            {% endfor %}
          </div>
          <button type="button" class="recipe-carousel-nav recipe-carousel-nav-right" onclick="scrollCarousel(this, 1)">›</button>
        </div>
      </div>
    {% endfor %}
    <div class="recipe-submit-section">
      <button type="submit">Create mealplan from selected meals</button>
    </div>
  {% endif %}
</form>

<script>
  function scrollCarousel(button, direction) {
    const wrapper = button.parentElement.querySelector('.recipe-carousel');
    const scrollAmount = wrapper.offsetWidth / 1.5;
    wrapper.scrollBy({ left: direction * scrollAmount, behavior: 'smooth' });
  }

  function toggleFavorite(event, button) {
    event.preventDefault();
    event.stopPropagation();
    const recipeId = button.dataset.id;
    const isUnsave = button.classList.contains('saved');
    const endpoint = isUnsave ? `/remove_favorite/${recipeId}` : `/save_favorite/${recipeId}`;

    fetch(endpoint, { method: "POST" })
      .then(res => {
        if (res.ok) {
          button.classList.toggle('saved');
        } else {
          alert("Recipe is already in favorites.");
        }
      })
      .catch(() => alert("Network error."));
  }

  function toggleOverlay(checkbox) {
    const card = checkbox.closest('.recipe-card');
    if (checkbox.checked) {
      card.classList.add('selected');
    } else {
      card.classList.remove('selected');
    }
  }
</script>
{% endblock %}