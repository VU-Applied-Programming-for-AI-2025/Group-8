{% extends "base.html" %}

{% block content %}
<div class="card">
    <h2>Personalized Recommendations</h2>
    <p>Based on your profile and needs, here are some recipe suggestions:</p>
    
    <div class="meal-plan-actions">
        <form method="POST" action="{{ url_for('spoonacular_builtin_mealplanner') }}" class="meal-plan-form">
            <input type="hidden" name="timeFrame" value="day">
            <input type="hidden" name="diet" value="health">
            <button type="submit" class="btn btn-generate">
                <i class="fas fa-magic"></i> Generate Complete Meal Plan
            </button>
        </form>
        
        <a href="{{ url_for('meal_planner') }}" class="btn btn-custom">
            <i class="fas fa-edit"></i> Create Custom Meal Plan
        </a>
    </div>
</div>

{% for meal_type, recipes in recipes_by_meal.items() %}
<div class="card">
    <h3>{{ meal_type|capitalize }}</h3>
    
    <div class="recipe-grid">
        {% for recipe in recipes %}
        <div class="recipe-card">
            {% if recipe.image %}
            <img src="{{ recipe.image }}" alt="{{ recipe.title }}">
            {% else %}
            <div class="recipe-image-placeholder">
                <i class="fas fa-utensils"></i>
            </div>
            {% endif %}
            
            <div class="recipe-card-content">
                <h4>{{ recipe.title }}</h4>
                <div class="recipe-meta">
                    <span><i class="fas fa-clock"></i> {{ recipe.readyInMinutes }} mins</span>
                    <span><i class="fas fa-utensils"></i> {{ recipe.servings }} servings</span>
                </div>
                
                <div class="recipe-actions">
                    <a href="{{ url_for('recipe_details', recipe_id=recipe.id) }}" class="btn btn-view">
                        <i class="fas fa-eye"></i> View
                    </a>
                    
                    <button class="btn btn-save favorite-btn {% if recipe.id in user.saved_recipes %}saved{% endif %}" 
                            data-recipe-id="{{ recipe.id }}">
                        <i class="{% if recipe.id in user.saved_recipes %}fas{% else %}far{% endif %} fa-heart"></i>
                        {% if recipe.id in user.saved_recipes %}Saved{% else %}Save{% endif %}
                    </button>
                    
                    <form method="POST" action="{{ url_for('meal_planner') }}" class="add-to-plan-form">
                        <input type="hidden" name="timeFrame" value="day">
                        <input type="hidden" name="meals" value="{{ recipe.id }}">
                        <button type="submit" class="btn btn-add">
                            <i class="fas fa-calendar-plus"></i> Add to Plan
                        </button>
                    </form>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endfor %}
{% endblock %}

{% block extra_css %}
<style>
    .meal-plan-actions {
        display: flex;
        gap: 15px;
        margin: 20px 0;
        flex-wrap: wrap;
    }
    
    .btn-generate {
        background-color: var(--pastel-purple);
    }
    
    .btn-custom {
        background-color: var(--pastel-blue);
    }
    
    .recipe-meta {
        display: flex;
        gap: 15px;
        margin: 10px 0;
        color: #666;
        font-size: 0.9rem;
    }
    
    .recipe-actions {
        display: flex;
        gap: 8px;
        margin-top: 15px;
        flex-wrap: wrap;
    }
    
    .btn-view {
        background-color: var(--pastel-green);
    }
    
    .btn-save {
        background-color: var(--pastel-pink);
    }
    
    .btn-save.saved {
        background-color: #ff9e9e;
    }
    
    .btn-add {
        background-color: var(--pastel-yellow);
    }
    
    .recipe-image-placeholder {
        height: 200px;
        background-color: #f0f0f0;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #999;
        font-size: 2rem;
    }
    
    @media (max-width: 768px) {
        .recipe-actions {
            flex-direction: column;
        }
        
        .recipe-actions .btn {
            width: 100%;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle save/unsave buttons
    document.querySelectorAll('.favorite-btn').forEach(btn => {
        btn.addEventListener('click', async function(e) {
            e.preventDefault();
            const recipeId = this.dataset.recipeId;
            const isSaved = this.classList.contains('saved');
            
            try {
                const endpoint = isSaved ? 
                    `/remove_favorite/${recipeId}` : 
                    `/save_favorite/${recipeId}`;
                
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });
                
                if (response.ok) {
                    this.classList.toggle('saved');
                    const icon = this.querySelector('i');
                    icon.classList.toggle('far');
                    icon.classList.toggle('fas');
                    this.innerHTML = this.classList.contains('saved') ? 
                        '<i class="fas fa-heart"></i> Saved' : 
                        '<i class="far fa-heart"></i> Save';
                } else {
                    alert('Failed to update favorites');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Network error occurred');
            }
        });
    });
    
    // Handle add to meal plan forms
    document.querySelectorAll('.add-to-plan-form').forEach(form => {
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding...';
            submitBtn.disabled = true;
            
            try {
                const response = await fetch(this.action, {
                    method: this.method,
                    body: formData,
                });
                
                if (response.ok) {
                    showFlashMessage('Recipe added to meal plan!', 'success');
                } else {
                    showFlashMessage('Failed to add to meal plan', 'error');
                }
            } catch (error) {
                showFlashMessage('Network error occurred', 'error');
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });
    });
});

function showFlashMessage(message, type) {
    const flashDiv = document.createElement('div');
    flashDiv.className = `flash-message ${type}`;
    flashDiv.textContent = message;
    
    const container = document.querySelector('.container');
    if (container) {
        container.prepend(flashDiv);
        
        setTimeout(() => {
            flashDiv.remove();
        }, 5000);
    }
}
</script>
{% endblock %}