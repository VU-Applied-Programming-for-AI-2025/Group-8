{% extends "base.html" %}

{% block content %}
<div class="card">
    <h2>Analysis Results for: {{ symptoms }}</h2>
    
    <div class="analysis-results">
        {% for line in analysis.split('\n') %}
            {% if line.strip() %}
                {% if line.startswith('[') and ']' in line %}
                    <h3>{{ line }}</h3>
                {% elif line.startswith('- Why:') %}
                    <p><strong>Why:</strong> {{ line[6:] }}</p>
                {% elif line.startswith('- Foods:') %}
                    <p><strong>Foods:</strong> {{ line[8:] }}</p>
                {% elif line.startswith('- Tip:') %}
                    <p><strong>Tip:</strong> {{ line[6:] }}</p>
                    <hr>
                {% elif line.startswith('[Urgency Note]:') %}
                    <div class="urgency-note">
                        <p><strong>Urgency Note:</strong> {{ line[15:] }}</p>
                    </div>
                {% else %}
                    <p>{{ line }}</p>
                {% endif %}
            {% endif %}
        {% endfor %}
    </div>
    
    <div class="actions">
        <button id="save-results" class="btn btn-primary">Save Results</button>
        <a href="{{ url_for('recommendations') }}" class="btn">Get Food Recommendations</a>
        <a href="{{ url_for('home') }}" class="btn">Back home</a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.getElementById('save-results').addEventListener('click', async function() {
        const analysisText = `{{ analysis|replace('\n', '\\n')|safe }}`;
        
        try {
            const response = await fetch('/save_results', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ analysis: analysisText })
            });
            
            if (response.ok) {
                alert('Results saved successfully!');
            } else {
                alert('Failed to save results');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Network error occurred');
        }
    });

    // Hide loading screen when results page loads
    window.addEventListener('load', function() {
        const loadingScreen = document.getElementById('loading-screen');
        if (loadingScreen) loadingScreen.classList.remove('active');
    });

    // Rest of your existing results page JS...
    document.getElementById('save-results').addEventListener('click', async function() {
        const analysisText = `{{ analysis|replace('\n', '\\n')|safe }}`;
        
        try {
            const response = await fetch('/save_results', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ analysis: analysisText })
            });
            
            if (response.ok) {
                alert('Results saved successfully!');
            } else {
                alert('Failed to save results');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Network error occurred');
        }
    });
</script>
{% endblock %}