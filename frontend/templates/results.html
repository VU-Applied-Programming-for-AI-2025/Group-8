{% extends "base.html" %}

{% block title %}Analysis Results{% endblock %}

{% block content %}
<div class="results-container">
    <h1>Analysis for "{{ symptoms }}"</h1>
    <pre id="analysis">{{ analysis }}</pre>

    <div class="link-wrapper">
        <a class="button-link" href="/recommendations">Get Personalized Recipes</a>
    </div>
</div>

<script>
    const rawText = document.getElementById("analysis").innerText;

    // Parser for Groq response
    const results = {};
    const lines = rawText.split("\n");

    let currentNutrient = null;

    for (let line of lines) {
        line = line.trim();

        // Nutrient name e.g. **Magnesium**:
        const nutrientMatch = line.match(/^\*\*(.+?)\*\*:/);
        if (nutrientMatch) {
            currentNutrient = nutrientMatch[1];
            results[currentNutrient] = {
                why: "",
                foods: [],
                tip: ""
            };
            continue;
        }

        if (currentNutrient && line.startsWith("- Why:")) {
            results[currentNutrient].why = line.replace("- Why:", "").trim();
        } else if (currentNutrient && line.startsWith("- Foods:")) {
            const foodList = line.replace("- Foods:", "").split(",");
            results[currentNutrient].foods = foodList.map(f => f.trim());
        } else if (currentNutrient && line.startsWith("- Tip:")) {
            results[currentNutrient].tip = line.replace("- Tip:", "").trim();
        }
    }

    const urgencyMatch = rawText.match(/\*\*Urgency Note\*\*: (.+)$/m);
    if (urgencyMatch) {
        results["Urgency Note"] = urgencyMatch[1].trim();
    }

    fetch("/save_results", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify(results)
    })
    .then(res => res.text())
    .then(data => {
        console.log("Saved to backend:", data);
    });
</script>
{% endblock %}
